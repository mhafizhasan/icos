angular.module('admin', ['conf'])
.config(['$stateProvider', '$urlRouterProvider', 'constant', function($stateProvider, $urlRouterProvider, constant) {

    $urlRouterProvider.otherwise('/register');

    $stateProvider
    .state('dashboard', {
        url: '/dashboard',
        views: {
            header: {
                templateUrl: constant.baseUrl + '/welcome/view/header_admin'
            },
            main: {
                templateUrl: constant.baseUrl + '/welcome/view/dashboard',
                controller: 'DashboardCtrl as dashboard'
            }
        }
    })
    .state('printform', {
        url: '/print/:appId',
        views: {
            // header: {
            //     templateUrl: constant.baseUrl + '/welcome/view/header_print'
            // },
            main: {
                templateUrl: constant.baseUrl + '/welcome/view/print',
                controller: 'PrintFormCtrl as printform'
            }
        }
    });
}])
.controller('DashboardCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {

    'use strict';

    var bookmark;

      $scope.selected = [];

      $scope.filter = {
        options: {
          debounce: 500
        }
      };

      $scope.query = {
        filter: '',
        order: 'reg_name',
        limit: 5,
        page: 1
      };

      $scope.removeFilter = function () {
        $scope.filter.show = false;
        $scope.query.filter = '';

        if($scope.filter.form.$dirty) {
          $scope.filter.form.$setPristine();
        }
      };

      $scope.$watch('query.filter', function (newValue, oldValue) {
        if(!oldValue) {
          bookmark = $scope.query.page;
        }

        if(newValue !== oldValue) {
          $scope.query.page = 1;
        }

        if(!newValue) {
          $scope.query.page = bookmark;
        }

        allRegistration();
      });


      var allRegistration = function () {
        $http.post(constant.baseUrl + '/welcome/allRegistration', {
            filter: $scope.query.filter,
            order: $scope.query.order,
            limit: $scope.query.limit,
            page: $scope.query.page
        }).success(function (response) {
            $scope.users = response.users;
            $scope.users.count = response.count;
            // $scope.modules = response.modules;
            // $scope.modules.count = response.count; //Object.keys(response.users).length;
        }).error(function () {
            console.log('E');
        });

      };
      allRegistration();

      $scope.refreshTable = function () {
        allRegistration();
      };

}])
.controller('PrintFormCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {

    console.log($state.params.appId);
    // Get data by regid
    var applicant = function () {
      $http.post(constant.baseUrl + '/welcome/applicantByRegId', {
          regid: $state.params.appId
      }).success(function (response) {
          console.log(response);
          if(response.status == "200") {
              $scope.reg = response.app;
          } else {
              $state.go('/register');
          }

      }).error(function () {
          console.log('E');
      });

    };
    applicant();

}]);

var inbos = angular
  .module('inbos', [
      'ngMaterial',
      'ngMessages',
      'ngSanitize',
      'naif.base64',
      'angularMoment',
      'ui.router',
      'md.data.table',
      'register',
      'admin'
  ])
  .config(function($mdThemingProvider) {
      var customBlueMap = $mdThemingProvider.extendPalette('light-blue', {
      'contrastDefaultColor': 'light',
      'contrastDarkColors': ['50'],
      '50': 'ffffff'
    });
    var background = $mdThemingProvider.extendPalette('light-blue', {
        'A100': 'f2f2f2'
    });
    $mdThemingProvider.definePalette('background', background);
    $mdThemingProvider.definePalette('customBlue', customBlueMap);

    // $mdThemingProvider.theme('docs-dark', 'default')
    //     .primaryPalette('yellow')
    //     .dark();

    $mdThemingProvider.theme('default')
      .primaryPalette('customBlue', {
        'default': '500',
        'hue-1': '50'})
      .accentPalette('amber');

    $mdThemingProvider.theme('input', 'default')
          .primaryPalette('grey');
  })
  .config(function($mdDateLocaleProvider) {
    //   $mdDateLocaleProvider.formatDate = function(date) {
    //     return moment(date).format('YYYY-MM-DD');
    //   };
  })
  .run(function($rootScope, $state, $http, constant) {
    //   console.log('RUN');
      if(localStorage.getItem('icos_token')) {
        //   console.log('TOKEN EXIST');
          $rootScope.token = localStorage.getItem('icos_token');
      } else {
        //   console.log('TOKEN NOT EXIST');
          $state.go('register');
      }
  });


  // Global constant
  angular.module('conf', [])
  .constant('constant', {
    //   baseUrl: 'http://localhost/icos'
        baseUrl: 'http://info.malaysia.gov.my/icos'
  });

  // Directives
  inbos.directive('unMatcher', function($timeout) {
      return {
          restrict: "A",
          require: "ngModel",
          link: function(scope, element, attributes, ngModel) {
              ngModel.$validators.unMatcher = function(modelValue) {
                  return attributes.unMatcher !== modelValue;
              };
          }
      };
  });

  inbos.directive('matcher', function($timeout) {
      return {
          restrict: "A",
          require: "ngModel",
          link: function(scope, element, attributes, ngModel) {
              ngModel.$validators.matcher = function(modelValue) {
                  return attributes.matcher === modelValue;
              };
          }
      };
  });

angular.module('login', ['conf'])
.config(['$stateProvider', '$urlRouterProvider', 'constant', function($stateProvider, $urlRouterProvider, constant) {

    $urlRouterProvider.otherwise('/welcome');

    $stateProvider
    .state('welcome', {
        url: '/welcome',
        views: {
            main: {
                templateUrl: constant.baseUrl + '/welcome/view/welcome',
                controller: 'WelcomeCtrl as welcome'
            }
        }
    })
    .state('login', {
        url: '/login',
        views: {
            main: {
                templateUrl: constant.baseUrl + '/welcome/view/login',
                controller: 'LoginCtrl as login'
            }
        }
    })
    .state('signup', {
        url: '/signup',
        views: {
            main: {
                templateUrl: constant.baseUrl + '/welcome/view/signup',
                controller: 'SignUpCtrl as signup'
            }
        }
    });
}])
.controller('WelcomeCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {



}])
.controller('LoginCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {

    $scope.doLogin = function(u) {

        $http.post(constant.baseUrl + '/user/login', {
            username: u.username,
            password: u.password
        }).success(function(response) {
            if(response.status == "200") {
                localStorage.setItem('houselord_token', response.token);
                $rootScope.token = localStorage.getItem('houselord_token');
                $state.go('dashboard');
            } else {
                console.log('Auth Failed');
            }
        }).error(function() {
            localStorage.clear();
            $state.go('welcome');
        });
    };


}])
.controller('SignUpCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {

    $scope.signUpSubmit = function(u) {

        $http.post(constant.baseUrl + '/user/signUp', {
            fullname: u.fullname,
            email: u.email,
            mobile: u.mobile,
            password: u.password
        }).success(function(response) {
            if(response.status == "200") {
                localStorage.setItem('houselord_token', response.token);
                $state.go('dashboard');
            }
        }).error(function() {
            localStorage.clear();
            $state.go('welcome');
        });
    };

}]);

angular.module('property', ['conf'])
.config(['$stateProvider', '$urlRouterProvider', 'constant', function($stateProvider, $urlRouterProvider, constant) {

    $urlRouterProvider.otherwise('/dashboard');

    $stateProvider
    .state('#/property/new', {
        url: '/property/new',
        views: {
            header: {
                templateUrl: constant.baseUrl + '/template/view/header'
            },
            main: {
                templateUrl: constant.baseUrl + '/property/view/register',
                controller: 'PropertyCtrl as property'
            }
        }
    });
}])
.controller('PropertyCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {

    $scope.step1 = true;
    $scope.step2 = false;
    $scope.step3 = false;
    $scope.step4 = false;
    $scope.step5 = false;

    console.log('property controller');

    var lkpPropertyType = function() {
        $http.post(constant.baseUrl + '/lookup/property/type', {
            token: $rootScope.token
        }).success(function(response) {
            if(response.status == "200") {
                $scope.lkp_property_type = response.lkp;
                
            } else {
                console.log('Err');
            }
        }).error(function() {
            localStorage.clear();
            $state.go('welcome');
        });
    };
    lkpPropertyType();

}]);

angular.module('register', ['conf'])
.config(['$stateProvider', '$urlRouterProvider', 'constant', function($stateProvider, $urlRouterProvider, constant) {

    $urlRouterProvider.otherwise('/register');

    $stateProvider
    .state('register', {
        url: '/register',
        views: {
            header: {
                templateUrl: constant.baseUrl + '/welcome/view/header'
            },
            main: {
                templateUrl: constant.baseUrl + '/welcome/view/register',
                controller: 'RegisterCtrl as register'
            }
        }
    });
}])
.controller('RegisterCtrl', ['$state', '$http', '$rootScope', '$scope', 'constant',
    function($state, $http, $rootScope, $scope, constant) {

        $scope.lkp_type = [
            {code: 'Official Media', description: 'Official Media'},
            {code: 'Local Media', description: 'Local Media'},
            {code: 'Foreign Media', description: 'Foreign Media'},
            {code: 'Secretariat', description: 'Secretariat'}
        ];

        $scope.lkp_gender = [
            { code: 'Male', description: 'Male' },
            { code: 'Female', description: 'Female' }
        ];

        $scope.lkp_id = [
            { code: 'New IC No', description: 'New IC No' },
            { code: 'Old IC No', description: 'Old IC No' },
            { code: 'Passport No', description: 'Passport No' }
        ];

        $scope.lkp_org = [
            { code: 'Newspaper', description: 'Newspaper' },
            { code: 'Magazine', description: 'Magazine' },
            { code: 'TV', description: 'TV' },
            { code: 'Radio', description: 'Radio' },
            { code: 'Photo Agency', description: 'Photo Agency' },
            { code: 'News Agency', description: 'News Agency' },
            { code: 'Others', description: 'Others' }
        ];

        $scope.lkp_designation = [
            { code: 'Secretariat', description: 'Secretariat' },
            { code: 'Reporter', description: 'Reporter' },
            { code: 'Cameraman', description: 'Cameraman' },
            { code: 'Editor', description: 'Editor' },
            { code: 'Correspondent', description: 'Correspondent' },
            { code: 'TV/Radio Commentator', description: 'TV/Radio Commentator' },
            { code: 'TV Commentator', description: 'TV Commentator' },
            { code: 'Technician', description: 'Technician' },
            { code: 'Others', description: 'Others' }

        ];

        $scope.isNewIC = true;
        $scope.isOldIC = false;
        $scope.isPassport = false;

        $scope.selectId = function() {
            if($scope.reg.lkp_id == "New IC No") {
                $scope.isNewIC = true;
                $scope.isOldIC = false;
                $scope.isPassport = false;
            } else if($scope.reg.lkp_id == "Old IC No") {
                $scope.isNewIC = false;
                $scope.isOldIC = true;
                $scope.isPassport = false;
            } else if($scope.reg.lkp_id == "Passport No") {
                $scope.isNewIC = false;
                $scope.isOldIC = false;
                $scope.isPassport = true;
            }
        }

        $scope.isOtherOrganisation = false;
        $scope.selectOrganisation = function() {
            console.log($scope.reg.lkp_org);
            if($scope.reg.lkp_org == "Others") {
                $scope.isOtherOrganisation = true;
            } else {
                $scope.isOtherOrganisation = false;
            }
        }

        $scope.isOtherDesignation = false;
        $scope.selectDesignation = function() {
            if($scope.reg.lkp_designation == "Others") {
                $scope.isOtherDesignation = true;
            } else {
                $scope.isOtherDesignation = false;
            }
        }

        // Submit application form
        $scope.submitApplication = function(reg) {

            console.log(reg);

            var pf;
            var ed;
            var p;
            if(reg.lkp_id == "Passport No") {
                pf = reg.passfile.filetype + ';base64,' + reg.passfile.base64;
                ed = moment(reg.expdate).format("YYYY-MM-DD");
                p = reg.passport;
            } else if(reg.lkp_id == "New IC No") {
                pf = '';
                ed = '';
                p = reg.newic;
            } else if(reg.lkp_id == "Old IC No") {
                pf = '';
                ed = '';
                p = reg.oldic;
            }

            var deo;
            if(reg.lkp_designation != "Others") {
                deo = '';
            } else {
                deo = reg.orgdesgo;
            }

            var oto;
            if(reg.lkp_org != "Others") {
                oto = '';
            } else {
                oto = reg.orgtypeo;
            }

            var dob = moment(reg.dob).format("YYYY-MM-DD");

            // if(reg.lkp_org != "Others") {
            //     reg.
            // }

            $http.post(constant.baseUrl + '/welcome/submitRegistration', {
                expdate: ed,
                dob: dob,
                fullname: reg.fullname,
                image: reg.image.filetype + ';base64,' + reg.image.base64,
                lkp_designation: reg.lkp_designation,
                lkp_gender: reg.lkp_gender,
                lkp_id: reg.lkp_id,
                lkp_org: reg.lkp_org,
                lkp_type: reg.lkp_type,
                namecard: reg.namecard,
                nationality: reg.nationality,
                orgadd: reg.orgadd,
                orgcountry: reg.orgcountry,
                orgdesgo: deo,
                orgemail: reg.orgemail,
                orgfax: reg.orgfax,
                orgmobile: reg.orgmobile,
                orgname: reg.orgname,
                orgtelo: reg.orgtelo,
                orgtypeo: oto,
                passfile: pf,
                passport: p,
                presscard: reg.presscard.filetype + ';base64,' + reg.presscard.base64,
                presscardno: reg.presscardno,
                pressedi: reg.pressedi
            }).success(function(response) {
                console.log(response);
            }).error(function() {
                console.log('E');
            });
        };

}])
.directive('btnUploadFile1', btnUploadFile1)
.directive('btnUploadFile2', btnUploadFile2)
.directive('btnUploadFile3', btnUploadFile3);

/**
 * Directive Upload Button
 * @return {[type]} [description]
 */
function btnUploadFile1() {
    var directive = {
       restrict: 'E',
       template: '<input id="fileInput1" name="fileInput1"  aria-label="uploadimage" type="file" class="ng-hide" ng-model="reg.image" required maxsize="2000" base-sixty-four-input accept="image/*"> <md-button id="uploadButton1" class="md-raised md-primary" aria-label="attach_file">    Upload  </md-button><md-input-container  md-no-float>    <input id="textInput1" ng-model="fileName1" type="text" style="color: #666;" placeholder="No file chosen" ng-readonly="true"></md-input-container>',
       link: btnUploadFileLink1
     };
     return directive;
}

function btnUploadFileLink1(scope, element, attrs) {
  var input = $(element[0].querySelector('#fileInput1'));
  var button = $(element[0].querySelector('#uploadButton1'));
  var textInput = $(element[0].querySelector('#textInput1'));

  if (input.length && button.length && textInput.length) {
    button.click(function(e) {
      input.click();
    });
    textInput.click(function(e) {
      input.click();
    });
  }

  input.on('change', function(e) {
    var files = e.target.files;
    if (files[0]) {
      scope.fileName1 = files[0].name;
    } else {
      scope.fileName1 = null;
    }
    scope.$apply();
  });
}

function btnUploadFile2() {
    var directive = {
       restrict: 'E',
       template: '<input id="fileInput2" name="fileInput2"  aria-label="uploadpass" type="file" class="ng-hide" ng-model="reg.passfile" required maxsize="2000" base-sixty-four-input accept="image/*"> <md-button id="uploadButton2" class="md-raised md-primary" aria-label="attach_file">    Upload  </md-button><md-input-container  md-no-float>    <input id="textInput2" ng-model="fileName2" type="text" style="color: #666;" placeholder="No file chosen" ng-readonly="true"></md-input-container>',
       link: btnUploadFileLink2
     };
     return directive;
}

function btnUploadFileLink2(scope, element, attrs) {
  var input = $(element[0].querySelector('#fileInput2'));
  var button = $(element[0].querySelector('#uploadButton2'));
  var textInput = $(element[0].querySelector('#textInput2'));

  if (input.length && button.length && textInput.length) {
    button.click(function(e) {
      input.click();
    });
    textInput.click(function(e) {
      input.click();
    });
  }

  input.on('change', function(e) {
    var files = e.target.files;
    if (files[0]) {
      scope.fileName2 = files[0].name;
    } else {
      scope.fileName2 = null;
    }
    scope.$apply();
  });
}

function btnUploadFile3() {
    var directive = {
       restrict: 'E',
       template: '<input id="fileInput3" name="fileInput3" aria-label="uploadcard" type="file" class="ng-hide" ng-model="reg.presscard" required base-sixty-four-input maxsize="2000" accept="image/*"> <md-button id="uploadButton3" class="md-raised md-primary" aria-label="attach_file">    Upload  </md-button><md-input-container  md-no-float>    <input id="textInput3" ng-model="fileName3" type="text" style="color: #666;" placeholder="No file chosen" ng-readonly="true"></md-input-container>',
       link: btnUploadFileLink3
     };
     return directive;
}

function btnUploadFileLink3(scope, element, attrs) {
  var input = $(element[0].querySelector('#fileInput3'));
  var button = $(element[0].querySelector('#uploadButton3'));
  var textInput = $(element[0].querySelector('#textInput3'));

  if (input.length && button.length && textInput.length) {
    button.click(function(e) {
      input.click();
    });
    textInput.click(function(e) {
      input.click();
    });
  }

  input.on('change', function(e) {
    var files = e.target.files;
    if (files[0]) {
      scope.fileName3 = files[0].name;
    } else {
      scope.fileName3 = null;
    }
    scope.$apply();
  });
}
